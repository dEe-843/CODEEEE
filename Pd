#include <stdio.h>

int touchDetected()
{
    int t;
    printf("Touch? (1=yes, 0=no): ");
    scanf("%d", &t);
    return t;
}

void delay1s()
{
    for (volatile long i = 0; i < 300000000; i++); // approx 1 sec
}

int main()
{
    int counter = 0;
    int prev = -1;

    int screen_on = 1;
    int logout_page = 0;

    int timeout_seconds = 5;    // user idle timeout
    int logout_wait = 3;        // show logout page for few seconds
    int idle_count = 0;         // counts seconds with no touch

    while (screen_on)
    {
        prev = counter;
        counter++;

        printf("\nPrev: %d  Curr: %d\n", prev, counter);

        // -------------------- Touch Check --------------------
        if (touchDetected())
        {
            printf("User touched! Reset idle counter.\n");
            idle_count = 0;
        }
        else
        {
            idle_count++;
            printf("No touch for %d sec\n", idle_count);
        }

        // ------------------ Screen Timeout -------------------
        if (idle_count >= timeout_seconds)
        {
            printf("\n*** TIMEOUT! Going to logout page ***\n");
            logout_page = 1;
            break;
        }

        delay1s();
    }

    // =====================================================
    //                LOGOUT PAGE
    // =====================================================
    if (logout_page)
    {
        printf("\n===== LOGOUT PAGE =====\n");

        for (int i = 0; i < logout_wait; i++)
        {
            prev = counter;
            counter++;

            printf("Logout Page | Prev: %d  Curr: %d\n",
                   prev, counter);

            delay1s();
        }

        printf("\nScreen turning OFF...\n");
        screen_on = 0;
    }

    return 0;
}



#include "definitions.h"    // Harmony headers

bool TouchDetected(void)
{
    // Replace with actual touch input
    return (PORTBbits.RB5 == 1);
}

int main(void)
{
    SYS_Initialize(NULL);

    uint32_t prev_sec = 0;
    uint32_t curr_sec = 0;

    uint32_t start_sec = 0;
    uint32_t idle_timeout = 10;    // 10s timeout
    uint32_t logout_wait = 5;      // show logout for 5s

    bool logout_page = false;
    bool running = true;

    // ----------- Get Base Start Time from RTC -----------
    RTC_TimeGet(&curr_sec);
    prev_sec = curr_sec;
    start_sec = curr_sec;

    while (running)
    {
        // Read current RTC second
        RTC_TimeGet(&curr_sec);

        // Print only when second changes
        if (curr_sec != prev_sec)
        {
            printf("Prev: %lu   Curr: %lu\n", prev_sec, curr_sec);

            // ---------------- TOUCH CHECK ----------------
            if (TouchDetected())
            {
                printf("Touch! Timeout Reset\n");
                start_sec = curr_sec;   // reset timeout
            }

            // -------------- TIMEOUT CHECK ----------------
            if ((curr_sec - start_sec) >= idle_timeout)
            {
                printf("\n*** Timeout! Going to logout page ***\n");
                logout_page = true;
                break;
            }

            prev_sec = curr_sec;
        }
    }

    // ======================================================
    //                     LOGOUT PAGE
    // ======================================================
    if (logout_page)
    {
        printf("\n===== LOGOUT PAGE =====\n");

        uint32_t logout_start;
        RTC_TimeGet(&logout_start);

        while (1)
        {
            RTC_TimeGet(&curr_sec);

            if (curr_sec != prev_sec)
            {
                printf("Logout | Prev: %lu  Curr: %lu\n",
                       prev_sec, curr_sec);
                prev_sec = curr_sec;
            }

            if ((curr_sec - logout_start) >= logout_wait)
                break;
        }

        printf("\nScreen turning OFF...\n");
    }

    while (1);
    return 0;
}
